# 同步逻辑优化与自动朗读设置修复计划

用户反馈了两个问题：
1.  自动朗读设置保存后刷新丢失。
2.  云端同步逻辑存在缺陷（删除后同步又出现，覆盖逻辑不明确）。

经过代码分析，这两个问题确实都与同步逻辑有关。目前的同步逻辑较为简单粗暴，容易导致本地设置被旧的云端数据覆盖，且缺乏对删除操作的同步支持。

## 问题分析

1.  **设置覆盖问题**:
    *   在 `handleSyncData` 中，虽然有冲突检测，但在静默同步（非交互式）时，如果本地配置与云端不一致，目前的逻辑是倾向于忽略或简单的合并。
    *   更关键的是，当用户保存设置时 (`saveSettings` in `dashboard.js`)，会立即触发一次 `triggerSync(false)` (静默同步)。
    *   如果云端没有最新的设置字段（例如 `autoPlayTTS`），或者云端的设置是旧的，同步逻辑可能会错误地用云端数据覆盖本地刚刚保存的数据，或者在合并时丢失新字段。
    *   `dashboard.js` 的 `showSettings` 加载逻辑中，对于缺省值处理也需要确保正确。

2.  **单词删除同步问题**:
    *   目前的同步策略是基于“合并”（Merge）且仅依赖 `timestamp`（创建时间）来决定保留哪个版本。
    *   当本地删除了一个单词，该单词记录从 `savedWords` 中消失。
    *   同步时，云端有该记录，本地没有。代码逻辑是：`if (!localEntry) { mergedWords[id] = cloudEntry; }`。
    *   **结果**：被删除的单词又被从云端拉回来。
    *   **解决方案**：需要引入“软删除”机制（Soft Delete）或同步删除记录（Tombstone）。在单词对象中增加 `deleted: true` 标记和 `updatedAt` 时间戳。

## 实施计划

### 1. 引入“软删除”机制 (Soft Delete)
*   **目标**: 解决删除后同步又出现的问题。
*   **修改**:
    *   **数据结构**: 单词对象增加 `isDeleted` (boolean) 和 `updatedAt` (timestamp) 字段。
    *   **保存单词 (`handleSaveWord`)**: 设置 `updatedAt = Date.now()`, `isDeleted = false`。
    *   **删除单词 (`handleRemoveWord`)**: 不再物理删除 key，而是设置 `isDeleted = true`, `updatedAt = Date.now()`。
    *   **列表渲染 (`loadWords`)**: 过滤掉 `isDeleted === true` 的单词。
    *   **同步逻辑 (`handleSyncData`)**:
        *   对比云端和本地的 `updatedAt`。
        *   取时间戳较新的版本。
        *   如果最新版本是 `isDeleted === true`，则最终结果中应保留该标记（或者如果两端都确认删除且超过一定时间可物理清除，目前先保留标记以确保同步正确）。

### 2. 优化设置同步策略
*   **目标**: 解决设置被云端旧数据覆盖的问题。
*   **修改**:
    *   **设置对象**: 给 `userSettings` 也增加 `updatedAt` 字段。
    *   **保存设置 (`saveSettings`)**: 更新 `userSettings.updatedAt`。
    *   **同步逻辑**:
        *   读取云端设置的 `updatedAt`（如果有）。
        *   比较本地和云端的 `updatedAt`。
        *   **策略**: 始终信任 `updatedAt` 更晚（更新）的一方。
        *   如果云端没有 `updatedAt`（旧数据），而本地有，则以本地为准（覆盖云端）。

### 3. 代码重构细节
*   **src/background/service-worker.js**:
    *   重写 `handleSyncData`，实现基于 `updatedAt` 的双向合并算法。
    *   重写 `handleRemoveWord` 为软删除。
    *   重写 `handleSaveWord` 增加 `updatedAt`。
*   **src/dashboard/dashboard.js**:
    *   修改 `loadWords` 增加过滤 `isDeleted`。
    *   修改 `saveSettings` 增加 `updatedAt` 时间戳。
    *   修改 `deleteWord` 调用逻辑（虽然前端调用不变，但后端处理变了）。

### 4. 验证步骤
1.  **设置同步**:
    *   修改设置（如开启自动朗读），保存。
    *   触发同步。
    *   刷新页面，确认设置未被回滚。
2.  **删除同步**:
    *   删除一个单词。
    *   触发同步。
    *   刷新页面，确认单词未重新出现。
    *   在另一端（模拟清除本地数据后同步）确认单词也不会出现。

这个计划将从根本上解决同步冲突和数据一致性问题。